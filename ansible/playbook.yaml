- name: copy file  to worker
  hosts: worker
  become: true
  tasks:
    - name: copy a file
      copy:
        src: ansible/compose.yaml
        dest: /home/compose.yaml

- name: install dependencies
  hosts: worker
  become: true
  tasks:
    - name: Install aptitude
      apt:
        name: aptitude
        state: latest
        update_cache: true

    - name: install dependencies
      apt:
        name: "{{item}}"
        state: present
        update_cache: yes
      loop:
        - apt-transport-https
        - ca-certificates
        - curl
        - gnupg-agent
        - software-properties-common
        - python3-pip

    - name: add GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: add docker repository to apt
      apt_repository:
        repo: deb https://download.docker.com/linux/ubuntu bionic stable
        state: present

    - name: install docker
      apt:
        name: "{{ item }}"
        state: latest
        update_cache: yes
      loop:
        - docker-ce

    - name: check docker is active
      service:
        name: docker
        state: started
        enabled: yes
    - name: Ensure group "docker" exists
      ansible.builtin.group:
        name: docker
        state: present

    - name: adding hostname to docker group
      user:
        name: umrullo
        groups: docker
        append: yes

    - name: Install  Python packages
      ansible.builtin.pip:
        name: "{{ item }}"
        state: present
      loop:
       - pyopenssl==23.2.0
       - docker
       - docker-compose
       - jsondiff

    - name: Init a new swarm with default parameters
      community.docker.docker_swarm:
        state: present
        advertise_addr: 192.168.1.39

    - name: Deploy stack from a compose file
      docker_stack:
        state: present
        name: Jenkins
        compose:
          - /home/compose.yaml
